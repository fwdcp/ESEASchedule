<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/core-label/core-label.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-input/paper-input-decorator.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">

<polymer-element name="eseaschedule-controls" attributes="startDate endDate selectedRegions selectedGames selectedDivisions selectedStatuses showScores showTeamInfo">
    <template>
        <link rel="stylesheet" href="../bower_components/materialize/dist/css/materialize.min.css">
        <style>
            paper-checkbox {
                padding: 15px 20px 15px 0;
            }
            paper-checkbox + p {
                line-height: 18px;
            }
        </style>

        <div class="row">
            <div id="regions" class="col s12 m2">
                <h5>Regions</h5>

                <template repeat="{{region in regions}}">
                    <core-label horizontal layout>
                        <paper-checkbox for checked data-region-id="{{region.id}}" on-change="{{changeSelections}}"></paper-checkbox>
                        <p>{{region.name}}</p>
                    </core-label>
                </template>
            </div>

            <div id="games" class="col s12 m2">
                <h5>Games</h5>

                <template repeat="{{game in games}}">
                    <core-label horizontal layout>
                        <paper-checkbox for checked data-game-id="{{game.id}}" on-change="{{changeSelections}}"></paper-checkbox>
                        <p>{{game.name}}</p>
                    </core-label>
                </template>
            </div>

            <div id="divisions" class="col s12 m2">
                <h5>Divisions</h5>

                <template repeat="{{division in divisions}}">
                    <core-label horizontal layout>
                        <paper-checkbox for checked data-division-id="{{division.id}}" on-change="{{changeSelections}}"></paper-checkbox>
                        <p>{{division.name}}</p>
                    </core-label>
                </template>
            </div>

            <div id="statuses" class="col s12 m2">
                <h5>Statuses</h5>

                <template repeat="{{status in statuses}}">
                    <core-label horizontal layout>
                        <paper-checkbox for checked data-status-id="{{status.id}}" on-change="{{changeSelections}}"></paper-checkbox>
                        <p>{{status.name}}</p>
                    </core-label>
                </template>
            </div>

            <div class="col s12 m2">
                <h5>Date Range</h5>

                <h6>Start</h6>
                <paper-input-decorator label="Start Date">
                    <input is="core-input" type="date" min="{{oldestDate | dateValueFormatter}}" max="{{endDate | dateValueFormatter}}" value="{{startDate | dateValueFormatter}}" id="startDate" on-change="{{changeSelections}}"></input>
                </paper-input-decorator>

                <h6>End</h6>
                <paper-input-decorator label="End Date">
                    <input is="core-input" type="date" min="{{startDate | dateValueFormatter}}" max="{{newestDate | dateValueFormatter}}" value="{{endDate | dateValueFormatter}}" id="endDate" on-change="{{changeSelections}}"></input>
                </paper-input-decorator>
            </div>

            <div class="col s12 m2">
                <h5>Options</h5>

                <div center horizontal layout>
                    <div flex>Show Scores</div>
                    <paper-toggle-button checked?="{{showScores}}" id="showScores" on-change="{{changeSelections}}"></paper-toggle-button>
                </div>

                <div center horizontal layout>
                    <div flex>Show Team Information</div>
                    <paper-toggle-button checked?="{{showTeamInfo}}" id="showTeamInfo" on-change="{{changeSelections}}"></paper-toggle-button>
                </div>
            </div>
        </div>

        <core-ajax
        url="/filters.json"
        handleAs="json"
        auto
        on-core-response="{{getFilters}}"></core-ajax>
    </template>

    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>

    <script>
        Polymer({
            "oldestDate": moment("2008-11-24"),
            "newestDate": moment(),
            "startDate": moment(),
            "endDate": moment(),
            "regions": [],
            "games": [],
            "divisions": [],
            "statuses": [{id: "pending", name: "Pending"}, {id: "upcoming", name: "Upcoming"}, {id: "live", name: "Live"}, {id: "completedNormal", name: "Completed"}, {id: "completedSpecial", name: "Forfeited/Overturned"}],
            "selectedRegions": [],
            "selectedGames": [],
            "selectedDivisions": [],
            "selectedStatuses": ["pending", "upcoming", "live", "completedNormal", "completedSpecial"],
            "showScores": false,
            "showTeamInfo": false,
            "getFilters": function(event, detail, sender) {
                if (sender.response) {
                    this.regions = sender.response.regions;
                    this.games = sender.response.games;
                    this.divisions = sender.response.divisions;
                    this.selectedRegions = _.map(sender.response.regions, function(value) {
                        return value.id;
                    });
                    this.selectedGames = _.map(sender.response.games, function(value) {
                        return value.id;
                    });
                    this.selectedDivisions = _.map(sender.response.divisions, function(value) {
                        return value.id;
                    });
                    this.startDate = moment(sender.response.weekBegin);
                    this.endDate = moment(sender.response.weekEnd);
                    this.oldestDate = moment(sender.response.oldestDate);
                    this.newestDate = moment(sender.response.nextWeekEnd);
                }
            },
            "dateValueFormatter": function(value) {
                return moment(value).format("YYYY-MM-DD");
            },
            "changeSelections": function(event, detail, sender) {
                this.startDate = moment(this.$.startDate.value);
                this.endDate = moment(this.$.endDate.value);

                this.selectedRegions = _.map(this.$.regions.querySelectorAll("paper-checkbox[checked]"), function(value) {
                    return value.dataset.regionId;
                });
                this.selectedGames = _.map(this.$.games.querySelectorAll("paper-checkbox[checked]"), function(value) {
                    return value.dataset.gameId;
                });
                this.selectedDivisions = _.map(this.$.divisions.querySelectorAll("paper-checkbox[checked]"), function(value) {
                    return value.dataset.divisionId;
                });
                this.selectedStatuses = _.map(this.$.statuses.querySelectorAll("paper-checkbox[checked]"), function(value) {
                    return value.dataset.statusId;
                });

                this.showScores = this.$.showScores.checked;
                this.showTeamInfo = this.$.showTeamInfo.checked;

                this.fire('selections-changed');
            }
        });
    </script>
</polymer-element>

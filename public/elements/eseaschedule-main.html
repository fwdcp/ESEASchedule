<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="eseaschedule-controls.html">
<link rel="import" href="eseaschedule-matches.html">

<polymer-element name="eseaschedule-main">
    <template>
        <link rel="stylesheet" href="../bower_components/materialize/dist/css/materialize.min.css">

        <eseaschedule-controls startDate="{{startDate}}" endDate="{{endDate}}" selectedRegions="{{selectedRegions}}" selectedGames="{{selectedGames}}" selectedDivisions="{{selectedDivisions}}" selectedStatuses="{{selectedStatuses}}" on-selections-changed="{{updateMatches}}"></eseaschedule-controls>
        <eseaschedule-matches id="matches"></eseaschedule-matches>

        <core-ajax
        url="/matches/{{startDate | dateValueFormatter}}/{{endDate | dateValueFormatter}}/list.json"
        handleAs="json"
        auto
        on-core-response="{{updateMatches}}"></core-ajax>
    </template>

    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>

    <script>
    Polymer({
        "matches": [],
        "dateValueFormatter": function(value) {
            return moment(value).format("YYYY-MM-DD");
        },
        "updateMatches": function(event, detail, sender) {
            if (sender.response) {
                this.matches = sender.response;
            }

            var matches = this.matches;

            matches = _.filter(matches, function(match) {
                return _.contains(this.selectedRegions, match.region_id);
            }, this);

            matches = _.filter(matches, function(match) {
                return _.contains(this.selectedGames, match.game_id);
            }, this);

            matches = _.filter(matches, function(match) {
                return _.contains(this.selectedDivisions, match.division_level);
            }, this);

            matches = _.filter(matches, function(match) {
                if (match.state == 'completed') {
                    return (match.outcome_type == 'normal' && _.contains(this.selectedStatuses, 'completedNormal')) || (match.outcome_type != 'normal' && _.contains(this.selectedStatuses, 'completedSpecial'));
                }
                else {
                    return _.contains(this.selectedStatuses, match.state);
                }
            }, this);

            matches = _.sortBy(matches, function(match) {
                return +match.date;
            })

            this.$.matches.matches = matches;
        }
    });
    </script>
</polymer-element>
